
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.7.4">
    
    
      
        <title>OpenMP 4.x - Performance Portability</title>
      
    
    
      <script src="../../../assets/javascripts/modernizr-1df76c4e58.js"></script>
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application-769c285a91.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-02c2a4388f.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="green" data-md-color-accent="yellow">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../../.." title="Performance Portability" class="md-logo md-header-nav__button">
            <img src="../../../images/oos.png" width="24" height="24">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  BoxLib
                </span>
              
                <span class="md-header-nav__parent">
                  Implementations
                </span>
              
            
            OpenMP 4.x
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-logo md-nav__button">
        <img src="../../../images/oos.png">
      </i>
    
    Performance Portability
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Office of Science Facilities
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Office of Science Facilities
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/comparison/" title="Comparison" class="md-nav__link">
      Comparison
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Performance Portability
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Performance Portability
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/definition/" title="Definition" class="md-nav__link">
      Definition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      Measurements
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        Measurements
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/" title="Measurement Techniques" class="md-nav__link">
      Measurement Techniques
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/knl/" title="Collecting Roofline on KNL" class="md-nav__link">
      Collecting Roofline on KNL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/gpu/" title="Collecting Roofline on GPUs" class="md-nav__link">
      Collecting Roofline on GPUs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      Approaches
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Approaches
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/libraries/" title="Libraries" class="md-nav__link">
      Libraries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3-2" type="checkbox" id="nav-3-3-2">
    
    <label class="md-nav__link" for="nav-3-3-2">
      Directives
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-3-2">
        Directives
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/directives/openacc/" title="OpenACC" class="md-nav__link">
      OpenACC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/directives/openmp/" title="OpenMP" class="md-nav__link">
      OpenMP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3-3" type="checkbox" id="nav-3-3-3">
    
    <label class="md-nav__link" for="nav-3-3-3">
      Frameworks
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-3-3">
        Frameworks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/frameworks/kokkos/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/frameworks/raja/" title="RAJA" class="md-nav__link">
      RAJA
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/dsl/" title="DSL" class="md-nav__link">
      DSL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/summary/" title="Summary" class="md-nav__link">
      Summary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4" checked>
    
    <label class="md-nav__link" for="nav-3-4">
      Case Studies
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        Case Studies
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-1" type="checkbox" id="nav-3-4-1" checked>
    
    <label class="md-nav__link" for="nav-3-4-1">
      BoxLib
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-1">
        BoxLib
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../parallelism/" title="Parallelism" class="md-nav__link">
      Parallelism
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../code_structure/" title="Code Structure" class="md-nav__link">
      Code Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../multigrid/" title="Geometric Multigrid" class="md-nav__link">
      Geometric Multigrid
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-1-5" type="checkbox" id="nav-3-4-1-5" checked>
    
    <label class="md-nav__link" for="nav-3-4-1-5">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-4-1-5">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
    <a href="./" title="OpenMP 4.x" class="md-nav__link md-nav__link--active">
      OpenMP 4.x
    </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/" title="GW Kernels" class="md-nav__link">
      GW Kernels
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-3" type="checkbox" id="nav-3-4-3">
    
    <label class="md-nav__link" for="nav-3-4-3">
      QCD
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-3">
        QCD
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/code_structure/" title="Code Structure" class="md-nav__link">
      Code Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-3-3" type="checkbox" id="nav-3-4-3-3">
    
    <label class="md-nav__link" for="nav-3-4-3-3">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-4-3-3">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/results_summary/" title="Results Summary" class="md-nav__link">
      Results Summary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../nek/" title="NekBone" class="md-nav__link">
      NekBone
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../md/" title="MD" class="md-nav__link">
      MD
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../resources/" title="Other Resources" class="md-nav__link">
      Other Resources
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="porting-boxlib-to-openmp-4x">Porting BoxLib to OpenMP 4.x<a class="headerlink" href="#porting-boxlib-to-openmp-4x" title="Permanent link">&para;</a></h1>
<p>Since version 4.0, OpenMP has supported accelerator devices through data
offloading and kernel execution semantics. OpenMP presents an appealing
opportunity to achieve performance portability, as it requires fairly
non-invasive code modifications through directives which are ignored as
comments if OpenMP is not activated during compilation.</p>
<p>BoxLib already contains a large amount of OpenMP in the C++ framework to
implement thread parallelization and loop tiling (see <a href="../parallelism/">here</a>
and <a href="../code_structure/">here</a> for more details). However, these directives are
limited to version 3.0 and older, and consist primarily of multi-threading of
loops, such that the Fortran kernel execution happens entirely within a
thread-private region. This approach yields high performance on self-hosted
systems such as Intel Xeon and Xeon Phi, but provides no support for
architectures featuring a discrete accelerator such as a GPU.</p>
<p>We implemented the OpenMP <code>target</code> construct in several of the geometric
multigrid kernels in BoxLib in order to support kernel execution on GPUs. The
most minimal approach to the <code>target</code> directive is simply to decorate a loop
with <code>target</code> and <code>map</code> to move the data back and forth between host and device
during execution of the loop (see, e.g.,
<a href="../../../../perfport/directives/openmp#omp-target">here</a>). However, this will
often lead to slow code execution, especially if the loop is encountered
multiple times, as the data must migrate back and forth between host and device
each time the loop is executed.</p>
<p>A more optimized approach is to allocate the data on the device prior to look
execution, such that it need not re-allocate it each time the loop executes
(any updated values of the data will still need to be updated on the device).
This can be done with the <code>target enter data</code> and <code>target exit data</code>
constructs, introduced in OpenMP 4.5. In BoxLib, we accomplished this by
overloading the default data container <code>Arena</code> (see
<a href="../code_structure#memory-management">here</a>) with a new <code>OMPArena</code> class which
invokes <code>omp target enter data</code> as soon as the memory is allocated. This
ensures that all FABs will be resident in device memory, obviating the need to
migrate all data in a loop back and forth between host and device:</p>
<div class="codehilite"><pre><span></span><span class="kt">void</span><span class="o">*</span>
<span class="n">OMPArena</span><span class="o">::</span><span class="n">alloc</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">_sz</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">pt</span><span class="o">=::</span><span class="k">operator</span> <span class="k">new</span><span class="p">(</span><span class="n">_sz</span><span class="p">);</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">ptr</span><span class="o">=</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">pt</span><span class="p">);</span>
<span class="cp">#pragma omp target enter data map(alloc:ptr[0:_sz])</span>
  <span class="k">return</span> <span class="n">pt</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">OMPArena</span><span class="o">::</span><span class="n">free</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">pt</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">ptr</span><span class="o">=</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">pt</span><span class="p">);</span>
<span class="cp">#pragma omp target exit data map(release:ptr[:0])</span>
    <span class="o">::</span><span class="k">operator</span> <span class="k">delete</span><span class="p">(</span><span class="n">pt</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>We also modified some existing macros in BoxLib which characterize loop-level
parallelism. In these directives we implemented the <code>target</code> construct, e.g.,:</p>
<div class="codehilite"><pre><span></span><span class="cp">#define ForAllThisCPencilAdd(T,b,ns,nc,red)                             \</span>
<span class="cp">{                                                                       \</span>
<span class="cp">    BL_ASSERT(contains(b));                                             \</span>
<span class="cp">    BL_ASSERT((ns) &gt;= 0 &amp;&amp; (ns) + (nc) &lt;= nComp());                     \</span>
<span class="cp">    const int *_th_plo = loVect();                                      \</span>
<span class="cp">    const int *_th_plen = length();                                     \</span>
<span class="cp">    const int *_b_lo = (b).loVect();                                    \</span>
<span class="cp">    IntVect b_length = (b).size();                                      \</span>
<span class="cp">    const int *_b_len = b_length.getVect();                             \</span>
<span class="cp">    const T* _th_p = dptr;                                              \</span>
<span class="cp">    const int _ns = (ns);                                               \</span>
<span class="cp">    const int _nc = (nc);                                               \</span>
<span class="cp">    T redR = (red);                                                     \</span>
<span class="cp">    _Pragma(&quot;omp target update to(_th_p[_ns*_th_plen[2]:(_ns+_nc)*_th_plen[2]])&quot;) \</span>
<span class="cp">    _Pragma(&quot;omp target data map(tofrom: redR) map(to: _nc, _ns, _th_plo[0:3], _th_plen[0:3], _b_len[0:3], _b_lo[0:3])&quot;) \</span>
<span class="cp">    _Pragma(&quot;omp target if(1)&quot;)                                         \</span>
<span class="cp">    {                                                                   \</span>
<span class="cp">    _Pragma(&quot;omp teams distribute parallel for collapse(3) reduction(+:redR)&quot;) \</span>
<span class="cp">    for(int _n = _ns; _n &lt; _ns+_nc; ++_n) {                             \</span>
<span class="cp">        for(int _k = 0; _k &lt; _b_len[2]; ++_k) {                         \</span>
<span class="cp">            for(int _j = 0; _j &lt; _b_len[1]; ++_j) {                     \</span>
<span class="cp">                int nR = _n; nR += 0;                                   \</span>
<span class="cp">                const int jR = _j + _b_lo[1];                           \</span>
<span class="cp">                const int kR = _k + _b_lo[2];                           \</span>
<span class="cp">                const T *_th_pp = _th_p                                 \</span>
<span class="cp">                    + ((_b_lo[0] - _th_plo[0])                          \</span>
<span class="cp">                       + _th_plen[0]*(                                  \</span>
<span class="cp">                           (jR - _th_plo[1])                            \</span>
<span class="cp">                           + _th_plen[1]*(                              \</span>
<span class="cp">                               (kR - _th_plo[2])                        \</span>
<span class="cp">                               + _n * _th_plen[2])));                   \</span>
<span class="cp">                for(int _i = 0; _i &lt; _b_len[0]; ++_i){                  \</span>
<span class="cp">                    const int iR = _i + _b_lo[0];                       \</span>
<span class="cp">                    const T &amp;thisR = _th_pp[_i];</span>
</pre></div>

<p>After this, one can add the <code>target teams distribute parallel for</code> construct to
many loops, moving to the device only the data which has changed since the
previous time the loop was executed. This can be done with the <code>update</code>
construct. For example, the restriction kernel in the multigrid solver becomes:</p>
<div class="codehilite"><pre><span></span> <span class="n">subroutine</span> <span class="n">FORT_AVERAGE</span> <span class="p">(</span>
<span class="err">$</span>     <span class="n">c</span><span class="p">,</span> <span class="n">DIMS</span><span class="p">(</span><span class="n">c</span><span class="p">),</span>
<span class="err">$</span>     <span class="n">f</span><span class="p">,</span> <span class="n">DIMS</span><span class="p">(</span><span class="n">f</span><span class="p">),</span>
<span class="err">$</span>     <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
     <span class="n">implicit</span> <span class="n">none</span>
     <span class="n">integer</span> <span class="n">nc</span>
     <span class="n">integer</span> <span class="n">DIMDEC</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
     <span class="n">integer</span> <span class="n">DIMDEC</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
     <span class="n">integer</span> <span class="n">lo</span><span class="p">(</span><span class="n">BL_SPACEDIM</span><span class="p">)</span>
     <span class="n">integer</span> <span class="n">hi</span><span class="p">(</span><span class="n">BL_SPACEDIM</span><span class="p">)</span>
     <span class="n">REAL_T</span> <span class="n">f</span><span class="p">(</span><span class="n">DIMV</span><span class="p">(</span><span class="n">f</span><span class="p">),</span><span class="n">nc</span><span class="p">)</span>
     <span class="n">REAL_T</span> <span class="n">c</span><span class="p">(</span><span class="n">DIMV</span><span class="p">(</span><span class="n">c</span><span class="p">),</span><span class="n">nc</span><span class="p">)</span>

     <span class="n">integer</span> <span class="n">i</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i2p1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">j2p1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k2p1</span><span class="p">,</span> <span class="n">n</span>

     <span class="o">!</span><span class="err">$</span><span class="n">omp</span> <span class="n">target</span> <span class="n">update</span> <span class="n">to</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

     <span class="o">!</span><span class="err">$</span><span class="n">omp</span> <span class="n">target</span> <span class="n">map</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="n">map</span><span class="p">(</span><span class="nl">to</span><span class="p">:</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">)</span>
     <span class="o">!</span><span class="err">$</span><span class="n">omp</span> <span class="n">teams</span> <span class="n">distribute</span> <span class="n">parallel</span> <span class="k">do</span> <span class="n">simd</span> <span class="n">collapse</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
     <span class="o">!&amp;</span><span class="n">omp</span> <span class="k">private</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span><span class="n">j2</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span> <span class="n">k2p1</span><span class="p">,</span> <span class="n">j2p1</span><span class="p">,</span><span class="n">i2p1</span><span class="p">)</span>
     <span class="k">do</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span>
        <span class="k">do</span> <span class="n">k</span> <span class="o">=</span> <span class="n">lo</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
           <span class="k">do</span> <span class="n">j</span> <span class="o">=</span> <span class="n">lo</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
               <span class="k">do</span> <span class="n">i</span> <span class="o">=</span> <span class="n">lo</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                  <span class="n">k2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">k</span>
                  <span class="n">k2p1</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">+</span> <span class="mi">1</span>
                  <span class="n">j2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">j</span>
                  <span class="n">j2p1</span> <span class="o">=</span> <span class="n">j2</span> <span class="o">+</span> <span class="mi">1</span>
                  <span class="n">i2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span>
                  <span class="n">i2p1</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="mi">1</span>
                  <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span>  <span class="p">(</span>
<span class="err">$</span>                     <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2</span>  <span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2</span>  <span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="err">$</span>                     <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2</span>  <span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2</span>  <span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="err">$</span>                     <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2p1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2p1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="err">$</span>                     <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2p1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2p1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="err">$</span>                     <span class="p">)</span><span class="o">*</span><span class="n">eighth</span>
               <span class="n">end</span> <span class="k">do</span>
           <span class="n">end</span> <span class="k">do</span>
        <span class="n">end</span> <span class="k">do</span>
     <span class="n">end</span> <span class="k">do</span>
     <span class="o">!</span><span class="err">$</span><span class="n">omp</span> <span class="n">end</span> <span class="n">teams</span> <span class="n">distribute</span> <span class="n">parallel</span> <span class="k">do</span> <span class="n">simd</span>
     <span class="o">!</span><span class="err">$</span><span class="n">omp</span> <span class="n">end</span> <span class="n">target</span>
 <span class="n">end</span>
</pre></div>

<p>Note that only <code>f</code>, which contains the fine grid data, needs to be updated on
the GPU before the loop begins. (This is because a few auxiliary functions
modify the finest grids which were not ported to the device, and so the finest
grid was updated on the host.) After the loop finishes, none of the data moves
off the device, since the fine grid <code>f</code> and the coarse grid <code>c</code> are not changed
on the host before the next kernel which requires this data executes on the
device. The only data which must be mapped to the device (but not mapped back)
are the <code>lo</code> and <code>hi</code> bounds of the loop indices.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../kokkos_implementation/" title="Kokkos" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Kokkos
              </span>
            </div>
          </a>
        
        
          <a href="../../gw/" title="GW Kernels" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                GW Kernels
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application-c35428f87f.js"></script>
      
      
      <script>app.initialize({url:{base:"../../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>